#!/bin/bash

#----------------------------------------------------------------------------------
# Project Name      - insit (Based on the older, Installit)
# Started On        - Wed 13 Dec 01:13:55 GMT 2017
# Last Change       - Sun 17 Dec 01:11:05 GMT 2017
# Author E-Mail     - terminalforlife@yahoo.com
# Author GitHub     - https://github.com/terminalforlife
#----------------------------------------------------------------------------------
# This installer is to replace the current installit. The aim of this installer is
# to do away with the need to have several installers, but instead combining them
# all into one easy-to-use installer, while making it more practical to update.
#
# WARNING: Do NOT use this installer until you see this warning line removed.
#          This is only temporary. Eventually the old one will be removed, if all
#          goes well with this "redo".
#
# Although this installer will hopefully replace the current installer, this one
# will still use the same old command line arguments, where possible.
#----------------------------------------------------------------------------------

XERR(){ printf "[L%0.4d] ERROR: %s\n" "$1" "$2" 1>&2; exit 1; }
ERR(){ printf "[L%0.4d] ERROR: %s\n" "$1" "$2" 1>&2; }

declare -i DEPCOUNT=0
for DEP in /usr/bin/wget /bin/{rm,chmod,chown,mkdir}; {
	[ -x "$DEP" ] || {
		ERR "$LINENO" "Dependency '$DEP' not met."
		DEPCOUNT+=1
	}
}

[ $DEPCOUNT -eq 0 ] || exit 1

USAGE(){
	while read -r; do
		printf "%s\n" "$REPLY"
	done <<-EOF
		            INSIT (17th December 2017)
		            Written by terminalforlife (terminalforlife@yahoo.com)
		
		            Installer for many shell programs from terminalforlife.

		SYNTAX:     insit [OPTS] WHAT1 WHAT2 WHAT3 . . .
		
		OPTS:       --help|-h|-?            - Displays this help information.
		            --debug                 - Enables the built-in bash debugging.
		            --quiet|-q              - Runs in quiet mode. Errors still output.
		            --update|-U             - Replace and update existing files.
		            --uninstall|-u          - Uninstall files installed here.
		            --available|-A          - Output all available programs.
		            --branch|-B NAME        - Where NAME is the branch to use.

		NOTE:       Where WHAT is the program(s) to install.

		WARNING:    Uninstalling with this program will permanently delete the files it
		            initially installed, but only if you don't have: /usr/bin/gvfs-trash

		            To check for this command, execute the following:

		              which /usr/bin/gvfs-trash
		
		SITE:       https://github.com/terminalforlife
	EOF
}

URL="https://raw.githubusercontent.com/terminalforlife"
BRANCH="master"

while [ "$1" ]; do
	case "$1" in
		--help|-h|-\?)
			USAGE; exit 0 ;;
		--debug)
			DEBUGME="true" ;;
		--quiet|-q)
			BEQUIET="true" ;;
		--update|-U)
			UPDATE="true" ;;
		--uninstall|-u)
			UNINSTALL="true" ;;
		--available|-A)
			AVAIL_SHOW="true" ;;
		--branch|-B)
			shift
			BRANCH="$1" ;;
		-*)
			XERR "$LINENO" "Incorrect argument(s) specified." ;;
		*)
			break ;;
	esac

	shift
done

if ! [ "$AVAIL_SHOW" == "true" ]; then
	[ $UID -eq 0 ] || XERR "$LINENO" "Root access is required."
fi

[ "$BEQUIET" == "true" ] && exec 1> /dev/null
[ "$DEBUGME" == "true" ] && set -xeu

FILE(){
	# FILE project_name "source_file.sh" "/usr/bin/target_file" 755
	if [ "$UNINSTALL" == "true" ]; then
		/bin/rm "$3"
	else
		/usr/bin/wget -q "$URL/$1/$BRANCH/$2" -O "$3"
		/bin/chown root:root "$3"
		/bin/chmod "$4" "$3"
	fi
}

AVAIL=(
	"lsbins - Simple shell program to list and describe the PATH executables."
	"github-ssh-setup - Simple shell program to create an SSH key pair for GitHub."
	"homewatch - Output files in HOME which have been modified today."
	"getip - View your internal and/or external IP address."
	"ripmydvd - Shell program using ffmpeg and mplayer to rip your DVD."
	"simwea - Simple program to display some weather statistics."
	"medlog - Need help taking and logging when you've had your medication?"
	"mif - Shell program to filter films by year and whether seen or not."
	"seewttr - Super-simple wrapper-like script to get your weather."
	"backmeup - Small tool I use to quickly and easily back up my HOME."
	"clean-locales - Remove some unnecessary non-English localizations."
	"mkpass - Pure Bourne Again Shell approach to complex password generation."
	"mplay - Simple script to allow me to quickly load mocp how I like."
	"pagewatch - Watch a webpage for signs of change by checkings its md5sum."
	"redshifter - Effective and simple tool to manually adjust the gamma via Redshift."
	"tozero - Simple program to display a countdown for a target date."
	"nosp - A workaround for the issue in XFCE wherein Smart Placement refuses to go away."
	"dlspwalls - Download a collection of steampunk wallpapers."
	"dlfcmags - Download issues of the Full Circle magazine PDFs."
	"dlfallwalls - Download a collection of Autumn/Fall wallpapers."
	"dl-tuxradar-podcasts - Small shell program to download the TuxRadar podcasts."
)

if ! [ "$AVAIL_SHOW" == "true" ]; then
	while [ "$1" ]; do
		case "$1" in
			lsbins)
				FILE lsbins lsbins /usr/bin/lsbins 755 ;;
			github-ssh-setup)
				FILE github-ssh-setup github-ssh-setup /usr/bin/github-ssh-setup 755 ;;
			homewatch)
				FILE homewatch homewatch /usr/bin/homewatch 755 ;;
			getip)
				FILE getip getip /usr/bin/getip 755 ;;
			ripmydvd)
				FILE ripmydvd ripmydvd /usr/bin/ripmydvd 755 ;;
			simwea)
				FILE simwea simwea /usr/bin/simwea 755 ;;
			medlog)
				FILE miscellaneous medlog /usr/bin/medlog 755 ;;
			mif)
				FILE miscellaneous mif /usr/bin/mif 755 ;;
			seewttr)
				FILE miscellaneous seewttr /usr/bin/seewttr 755 ;;
			backmeup)
				FILE miscellaneous backmeup /usr/bin/backmeup 755 ;;
			clean-locales)
				FILE miscellaneous clean-locales /usr/bin/clean-locales 755 ;;
			mkpass)
				FILE miscellaneous mkpass /usr/bin/mkpass 755 ;;
			mplay)
				FILE miscellaneous mplay /usr/bin/mplay 755 ;;
			pagewatch)
				FILE miscellaneous pagewatch /usr/bin/pagewatch 755 ;;
			redshifter)
				FILE miscellaneous redshifter /usr/bin/redshifter 755 ;;
			tozero)
				FILE miscellaneous tozero /usr/bin/tozero 755 ;;
			nosp)
				FILE miscellaneous nosp /usr/bin/nosp 755 ;;
			dlspwalls)
				FILE miscellaneous dlspwalls /usr/bin/dlspwalls 755 ;;
			dlfcmags)
				FILE miscellaneous dlfcmags /usr/bin/dlfcmags 755 ;;
			dlfallwalls)
				FILE miscellaneous dlfallwalls /usr/bin/dlfallwalls 755 ;;
			dl-tuxradar-podcasts)
				FILE miscellaneous dl-tuxradar-podcasts /usr/bin/dl-tuxradar-podcasts 755 ;;
			*)
				ERR "$LINENO" "Unavailable WHAT at: $1" ;;
		esac
	
		shift
	done
else
	printf "%s\n" "${AVAIL[@]}"
fi
